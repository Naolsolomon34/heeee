<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Essay & Resume Checker</title>
  <link rel="icon" href="/public/favicon.svg" />
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <header class="site-header">
    <div class="wrap">
      <div class="brand"><div class="dot"></div><span>Essay Checker</span></div>
      <nav class="nav">
        <a href="/" class="nav-link">Home</a>
        <a href="/why.html" class="nav-link">Why it works</a>
        <a href="/help.html" class="nav-link">Help</a>
      </nav>
    </div>
  </header>

  <main class="wrap grid">
    <!-- Editor -->
    <section class="card">
      <div class="card-head">
        <h1 class="title">Write or paste your text</h1>
        <div id="counter" class="counter">0 words · 0 chars</div>
      </div>

      <textarea id="text" spellcheck="true" placeholder="Paste your essay or resume here..."></textarea>

      <div class="toolbar">
        <div class="left">
          <button id="analyzeBtn" class="btn btn-primary">Analyze</button>
          <button id="spellFixBtn" class="btn btn-quiet" title="Ctrl+Alt+X">Spell Fix</button>
          <button id="demoBtn" class="btn btn-quiet">Use demo text</button>
          <button id="clearBtn" class="btn btn-quiet">Clear</button>
        </div>
        <div class="right">
          <span class="kbd">Ctrl/Cmd + Enter</span>
          <span class="dot-sep"></span>
          <span class="kbd">Ctrl+Alt+X</span><span class="hint-lite"> Spell Fix</span>
        </div>
      </div>
      <p id="error" class="error" style="display:none"></p>
    </section>

    <!-- Results -->
    <section id="results" class="card" style="display:none"></section>

    <!-- Account / Saved Docs -->
    <aside class="card side">
      <h2 class="side-title">Account</h2>
      <div id="authBox">
        <div id="authState" class="history-empty">Checking session…</div>
        <div id="authForm" style="margin-top:10px">
          <input id="email" placeholder="email@example.com" style="width:100%;padding:10px 12px;border:1px solid #e8eaf2;border-radius:10px;margin-bottom:8px" />
          <input id="pass" type="password" placeholder="password" style="width:100%;padding:10px 12px;border:1px solid #e8eaf2;border-radius:10px;margin-bottom:8px" />
          <div class="actions">
            <button id="signup" class="btn btn-quiet">Sign up</button>
            <button id="login" class="btn btn-quiet">Log in</button>
          </div>
        </div>
        <div id="authActions" class="actions" style="display:none;margin-top:8px">
          <button id="logout" class="btn btn-quiet">Log out</button>
        </div>
      </div>

      <h2 class="side-title" style="margin-top:18px">Saved</h2>
      <div id="saved" class="history-empty">Sign in to see your saved documents.</div>
    </aside>
  </main>

  <footer class="site-footer">
    <div class="wrap"><span>Built as an MVP for learning and demo purposes.</span></div>
  </footer>

  <script>
    const $=s=>document.querySelector(s);
    const box=$('#text'), counter=$('#counter'), err=$('#error'), out=$('#results');

    const btnAnalyze=$('#analyzeBtn'), btnSpellFix=$('#spellFixBtn'), btnDemo=$('#demoBtn'), btnClear=$('#clearBtn');

    // live counter
    function updateCounts(){
      const text=box.value;
      const words=(text.match(/[\p{L}\p{N}’'-]+/gu)||[]).length;
      const chars=text.length;
      counter.textContent=`${words} words · ${chars} chars`;
      localStorage.setItem('ec_draft', text || '');
    }
    box.addEventListener('input',updateCounts);
    (function initDraft(){ const d=localStorage.getItem('ec_draft'); if(d){ box.value=d; } updateCounts(); })();

    // spell fix + shortcuts
    function spellFix(t){
      const fixes={'teh':'the','recieve':'receive','seperate':'separate','definately':'definitely','occured':'occurred','accomodate':'accommodate','adress':'address','embarass':'embarrass','wich':'which','wierd':'weird'};
      t=t.replace(/\b(teh|recieve|seperate|definately|occured|accomodate|adress|embarass|wich|wierd)\b/gi,m=>fixes[m.toLowerCase()]);
      t=t.replace(/(^|[\s“"(\[])(i)([ \.,;:!\?)\]’"”]|$)/g,(_,a,b,c)=>`${a}I${c}`);
      t=t.replace(/[ \t]+/g,' ').replace(/ ?([,;:\.\!\?])/g,'$1 ').replace(/\s+([’”"\)\]\}])/g,'$1').replace(/([(\[\{“‘])\s+/g,'$1');
      t=t.replace(/(^|[\.!\?]\s+)([a-z])([A-Z])/g,(_,a,b,c)=>a+b.toUpperCase()+c.toLowerCase());
      return t.trim();
    }
    btnSpellFix.onclick=()=>{ box.value=spellFix(box.value); updateCounts(); };
    document.addEventListener('keydown',e=>{ const ctrlOrCmd=e.ctrlKey||e.metaKey; if(ctrlOrCmd&&e.altKey&&e.key.toLowerCase()==='x'){ e.preventDefault(); btnSpellFix.click(); }});
    box.addEventListener('keydown',e=>{ if((e.metaKey||e.ctrlKey)&&e.key.toLowerCase()==='enter') analyze(); });

    // analyze + save if logged in
    async function analyze(){
      hideError();
      const text=(box.value||'').trim();
      if(!text) return showError('Please paste some text first.');
      btnAnalyze.disabled=true; btnAnalyze.textContent='Analyzing…';
      try{
        const res=await fetch('/analyze',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});
        const data=await res.json().catch(()=>({}));
        if(!res.ok) throw new Error(data.error||('HTTP '+res.status));

        const rows=(data.items||[]).map(i=>`<tr><td>${cap(i.category)}</td><td>${i.score}/10</td><td>${escapeHtml(i.comment)}</td></tr>`).join('');
        const html=`
          <div class="results-head"><div class="badge">${data.percent}%</div>
          <div><div class="meta">${data.total} / ${data.out_of}</div><p class="summary">${escapeHtml(data.summary)}</p></div></div>
          <table class="rubric"><thead><tr><th>Category</th><th>Score</th><th>Comment</th></tr></thead><tbody>${rows}</tbody></table>
          <div class="suggestions"><h3>Top Suggestions</h3><ul>${(data.suggestions||[]).map(s=>`<li>${escapeHtml(s)}</li>`).join('')}</ul></div>`;
        out.innerHTML=html; out.style.display='';

        // try save (if logged in)
        const me = await getMe();
        if (me) {
          await fetch('/api/docs', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ text, html, meta:{ percent:data.percent } })});
          await loadSaved();
        }
      }catch(e){ showError(e?.message||'Something went wrong'); }
      finally{ btnAnalyze.disabled=false; btnAnalyze.textContent='Analyze'; }
    }
    btnAnalyze.onclick=analyze;

    // auth UI
    const authState=$('#authState'), authForm=$('#authForm'), authActions=$('#authActions');
    const email=$('#email'), pass=$('#pass');
    $('#signup').onclick=async()=>{ const r=await post('/api/auth/signup',{email:email.value.trim(),password:pass.value}); if(r.ok){ email.value=''; pass.value=''; renderAuthed(r.user.email); await loadSaved(); } else alert(r.error||'Signup failed'); };
    $('#login').onclick=async()=>{ const r=await post('/api/auth/login',{email:email.value.trim(),password:pass.value}); if(r.ok){ email.value=''; pass.value=''; renderAuthed(r.user.email); await loadSaved(); } else alert(r.error||'Login failed'); };
    $('#logout').onclick=async()=>{ await fetch('/api/auth/logout',{method:'POST'}); renderLoggedOut(); };

    async function initAuth(){ const me=await getMe(); if(me){ renderAuthed(me.email); await loadSaved(); } else renderLoggedOut(); }
    function renderAuthed(email){ authState.textContent = `Signed in as ${email}`; authForm.style.display='none'; authActions.style.display=''; $('#saved').textContent='Loading…'; }
    function renderLoggedOut(){ authState.textContent='You are not signed in.'; authForm.style.display=''; authActions.style.display='none'; $('#saved').textContent='Sign in to see your saved documents.'; }
    async function loadSaved(){ const r=await fetch('/api/docs'); if(r.ok){ const {docs}=await r.json(); renderSaved(docs); } }
    function renderSaved(docs){ const el=$('#saved'); if(!docs || !docs.length){ el.className='history-empty'; el.textContent='No saved documents yet.'; return; } el.className='history'; el.innerHTML=docs.map(d=>`<div class="hist"><div class="hist-top"><span class="chip">${(d.data?.meta?.percent??'–')}%</span><span class="time">${new Date(d.ts).toLocaleString()}</span></div><div class="preview">${escapeHtml(d.preview)}${d.preview.length>180?'…':''}</div></div>`).join(''); }

    // helpers
    function showError(m){ err.textContent=m; err.style.display=''; }
    function hideError(){ err.textContent=''; err.style.display='none'; }
    function cap(s){ return s? s[0].toUpperCase()+s.slice(1):s; }
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    async function post(url, body){ const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); return r.json().catch(()=>({})); }
    async function getMe(){ const r=await fetch('/api/auth/me'); if(!r.ok) return null; const j=await r.json(); return j.user; }

    // init
    initAuth();
  </script>
</body>
</html>


