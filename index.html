<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Essay & Resume Checker</title>
  <link rel="icon" href="/public/favicon.svg" />
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <header class="site-header">
    <div class="wrap">
      <div class="brand"><div class="dot"></div><span>Essay Checker</span></div>
      <nav class="nav">
        <a href="/" class="nav-link">Home</a>
        <a href="/why.html" class="nav-link">Why it works</a>
        <a href="/help.html" class="nav-link">Help</a>
      </nav>
    </div>
  </header>

  <main class="wrap grid">
    <!-- Editor -->
    <section class="card">
      <div class="card-head">
        <h1 class="title">Write or paste your text</h1>
        <div id="counter" class="counter">0 words · 0 chars</div>
      </div>

      <textarea id="text" spellcheck="true" placeholder="Paste your essay or resume here..."></textarea>

      <div class="toolbar">
        <div class="left">
          <button id="analyzeBtn" class="btn btn-primary">Analyze</button>
          <button id="spellFixBtn" class="btn btn-quiet" title="Ctrl+Alt+X">Spell Fix</button>
          <button id="demoBtn" class="btn btn-quiet">Use demo text</button>
          <button id="clearBtn" class="btn btn-quiet">Clear</button>
        </div>
        <div class="right">
          <span class="kbd">Ctrl/Cmd + Enter</span>
          <span class="dot-sep"></span>
          <span class="kbd">Ctrl+Alt+X</span><span class="hint-lite"> Spell Fix</span>
        </div>
      </div>
      <p id="error" class="error" style="display:none"></p>
    </section>

    <!-- Results -->
    <section id="results" class="card" style="display:none"></section>

    <!-- History -->
    <aside class="card side">
      <h2 class="side-title">History</h2>
      <div id="history" class="history-empty">No history yet.</div>
      <div class="actions">
        <button id="clearHist" class="btn btn-quiet">Clear history</button>
      </div>
    </aside>
  </main>

  <footer class="site-footer">
    <div class="wrap"><span>Built as an MVP for learning and demo purposes.</span></div>
  </footer>

  <script>
    const $=s=>document.querySelector(s);
    const box=$('#text'), counter=$('#counter'), err=$('#error'), out=$('#results');
    const btnAnalyze=$('#analyzeBtn'), btnSpellFix=$('#spellFixBtn'), btnDemo=$('#demoBtn'), btnClear=$('#clearBtn'), btnClearHist=$('#clearHist');

    function updateCounts(){
      const text=box.value;
      const words=(text.match(/[\p{L}\p{N}’'-]+/gu)||[]).length;
      const chars=text.length;
      counter.textContent=`${words} words · ${chars} chars`;
      saveDraft();
    }
    box.addEventListener('input',updateCounts);

    function spellFix(t){
      const fixes={'teh':'the','recieve':'receive','seperate':'separate','definately':'definitely','occured':'occurred','accomodate':'accommodate','adress':'address','embarass':'embarrass','wich':'which','wierd':'weird'};
      t=t.replace(/\b(teh|recieve|seperate|definately|occured|accomodate|adress|embarass|wich|wierd)\b/gi,m=>fixes[m.toLowerCase()]);
      t=t.replace(/(^|[\s“"(\[])(i)([ \.,;:!\?)\]’"”]|$)/g,(_,a,b,c)=>`${a}I${c}`);
      t=t.replace(/[ \t]+/g,' ').replace(/ ?([,;:\.\!\?])/g,'$1 ').replace(/\s+([’”"\)\]\}])/g,'$1').replace(/([(\[\{“‘])\s+/g,'$1');
      t=t.replace(/(^|[\.!\?]\s+)([a-z])([A-Z])/g,(_,a,b,c)=>a+b.toUpperCase()+c.toLowerCase());
      return t.trim();
    }
    btnSpellFix.addEventListener('click',()=>{ box.value=spellFix(box.value); updateCounts(); });
    document.addEventListener('keydown',e=>{ const ctrlOrCmd=e.ctrlKey||e.metaKey; if(ctrlOrCmd&&e.altKey&&e.key.toLowerCase()==='x'){ e.preventDefault(); btnSpellFix.click(); }});

    async function analyze(){
      hideError();
      const text=(box.value||'').trim();
      if(!text){ return showError('Please paste some text first.'); }
      btnAnalyze.disabled=true; btnAnalyze.textContent='Analyzing…';
      try{
        const url=new URL('/analyze',window.location.origin);
        const res=await fetch(url.toString(),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});
        const data=await res.json().catch(()=>({}));
        if(!res.ok) throw new Error(data.error||('HTTP '+res.status));

        const rows=(data.items||[]).map(i=>`<tr><td>${cap(i.category)}</td><td>${i.score}/10</td><td>${escapeHtml(i.comment)}</td></tr>`).join('');
        out.innerHTML=`
          <div class="results-head">
            <div class="badge">${data.percent}%</div>
            <div><div class="meta">${data.total} / ${data.out_of}</div><p class="summary">${escapeHtml(data.summary)}</p></div>
          </div>
          <table class="rubric"><thead><tr><th>Category</th><th>Score</th><th>Comment</th></tr></thead><tbody>${rows}</tbody></table>
          <div class="suggestions"><h3>Top Suggestions</h3><ul>${(data.suggestions||[]).map(s=>`<li>${escapeHtml(s)}</li>`).join('')}</ul></div>
          <div class="actions"><button id="copyBtn" class="btn btn-quiet">Copy Summary</button><button id="downloadBtn" class="btn btn-quiet">Download JSON</button><button id="downloadTxtBtn" class="btn btn-quiet">Download TXT</button></div>
        `;
        out.style.display='';
        $('#copyBtn').onclick=async()=>{ const summary=`Score: ${data.percent}% (${data.total}/${data.out_of})\n`+(data.items||[]).map(i=>`${i.category}: ${i.score}/10 — ${i.comment}`).join('\n')+`\nSuggestions:\n- `+(data.suggestions||[]).join('\n- '); await navigator.clipboard.writeText(summary); alert('Summary copied'); };
        $('#downloadBtn').onclick=()=>downloadBlob(JSON.stringify(data,null,2),'analysis.json','application/json');
        $('#downloadTxtBtn').onclick=()=>{ const textOut=`Score: ${data.percent}% (${data.total}/${data.out_of})\n`+(data.items||[]).map(i=>`${i.category}: ${i.score}/10 — ${i.comment}`).join('\n')+`\n\nSuggestions:\n- `+(data.suggestions||[]).join('\n- '); downloadBlob(textOut,'analysis.txt','text/plain'); };
        addHistory({ts:Date.now(),percent:data.percent,text,html:out.innerHTML,data});
      }catch(e){ showError(e?.message||'Something went wrong'); }
      finally{ btnAnalyze.disabled=false; btnAnalyze.textContent='Analyze'; }
    }
    btnAnalyze.addEventListener('click',analyze);
    box.addEventListener('keydown',e=>{ if((e.metaKey||e.ctrlKey)&&e.key.toLowerCase()==='enter') analyze(); });

    // Demo / Clear
    btnDemo.onclick=()=>{ box.value=`Since middle school I have chased challenges, but I learned the most when I slowed down and reflected.
For example, I led our class fundraiser and tracked costs; we increased revenue by 28% in one month.
I now focus on clarity and specific impact rather than vague ambition. Ultimately, my goal is to build tools that help students learn faster without losing their voice.`; updateCounts(); };
    btnClear.onclick=()=>{ box.value=''; updateCounts(); saveDraft(); };

    // History
    function addHistory(entry){ const arr=JSON.parse(localStorage.getItem('ec_history')||'[]'); arr.unshift(entry); localStorage.setItem('ec_history',JSON.stringify(arr.slice(0,5))); renderHistory(); }
    function renderHistory(){ const arr=JSON.parse(localStorage.getItem('ec_history')||'[]'); const el=$('#history'); if(!arr.length){ el.className='history-empty'; el.textContent='No history yet.'; return; } el.className='history'; el.innerHTML=arr.map((e,i)=>`<div class="hist"><div class="hist-top"><span class="chip">${e.percent}%</span><span class="time">${new Date(e.ts).toLocaleString()}</span></div><div class="preview">${escapeHtml((e.text||'').slice(0,180))}${(e.text||'').length>180?'…':''}</div><div class="hist-actions"><button class="btn btn-quiet" onclick="loadFromHistory(${i})">Load</button><button class="btn btn-quiet" onclick="downloadJson(${i})">JSON</button></div></div>`).join(''); }
    window.loadFromHistory=function(i){ const arr=JSON.parse(localStorage.getItem('ec_history')||'[]'); if(!arr[i]) return; box.value=arr[i].text||''; updateCounts(); out.style.display=''; out.innerHTML=arr[i].html||'(No cached HTML)'; window.scrollTo({top:0,behavior:'smooth'}); }
    window.downloadJson=function(i){ const arr=JSON.parse(localStorage.getItem('ec_history')||'[]'); if(!arr[i]) return; downloadBlob(JSON.stringify(arr[i].data,null,2),'analysis.json','application/json'); }

    // Helpers
    function downloadBlob(content,name,type){ const blob=new Blob([content],{type}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url); }
    function showError(m){ err.textContent=m; err.style.display=''; }
    function hideError(){ err.textContent=''; err.style.display='none'; }
    function cap(s){ return s? s[0].toUpperCase()+s.slice(1):s; }
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function saveDraft(){ localStorage.setItem('ec_draft', box.value||''); }
    function loadDraft(){ const d=localStorage.getItem('ec_draft'); if(d){ box.value=d; } }

    // init
    loadDraft(); updateCounts(); renderHistory();
  </script>
</body>
</html>

